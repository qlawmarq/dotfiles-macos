# iPhone から macOS へのリモートアクセス設定ガイド

このドキュメントでは、iPhone から macOS に安全にリモートアクセスし、開発作業を可能にするための設定手順を説明します。

---

## 目次

- [概要](#概要)
- [技術スタックの特徴](#技術スタックの特徴)
  - [Tailscale の強み](#tailscale-の強み)
  - [Mosh の強み](#mosh-の強み)
  - [tmux の強み](#tmux-の強み)
- [アーキテクチャ](#アーキテクチャ)
- [必要なもの](#必要なもの)
- [セットアップ手順](#セットアップ手順)
  - [1. macOS 側の設定](#1-macos-側の設定)
  - [2. iPhone 側の設定](#2-iphone-側の設定)
  - [3. 接続テスト](#3-接続テスト)
- [基本的な使い方](#基本的な使い方)
- [トラブルシューティング](#トラブルシューティング)
- [セキュリティについて](#セキュリティについて)

---

## 概要

このセットアップでは、以下のツールを組み合わせて快適なリモート開発環境を構築します:

- **Tailscale**: ピアツーピア型のメッシュ VPN（ポート開放不要）
- **Mosh**: モバイル環境に最適化されたリモートシェル
- **tmux**: 永続的なターミナルセッション管理

---

## 技術スタックの特徴

### Tailscale の強み

**ピアツーピアのメッシュ VPN アーキテクチャ**

従来の VPN は中央のゲートウェイサーバーを経由するため、以下の問題がありました：

- サーバーの場所次第で遅延が大きくなる
- 中央集約によるボトルネックでスループットが低下
- 単一障害点（サーバーダウンで全体が影響を受ける）

Tailscale はデバイス間を直接接続するため、これらの問題を解決します。

**主な技術的特徴**:

- **WireGuard プロトコル**: 最新の高性能 VPN プロトコルを採用
- **NAT トラバーサル**: ファイアウォールやルーターの設定変更なしで接続可能
- **ゼロコンフィグ**: 複雑なネットワーク設定が不要
- **エンドツーエンド暗号化**: すべての通信が暗号化される
- **固定 IP アドレス**: 各デバイスに `100.x.y.z` 形式の固定 IP が自動割り当て

### Mosh の強み

**モバイル環境に最適化されたリモートシェル**

SSH の制約を克服するために設計された次世代リモートシェルです。

**主な技術的特徴**:

1. **接続のローミング対応**

   - IP アドレスが変わっても接続を維持（Wi-Fi ↔ LTE の切り替えに対応）
   - スリープからの復帰時も接続が継続

2. **インスタントレスポンス（予測的ローカルエコー）**

   - サーバーの応答を待たずにキー入力を即座に表示
   - 遅延のある回線でも快適に操作可能
   - 予測が不確実な場合はアンダーラインで表示

3. **パケットロスへの耐性**

   - UDP ベースのプロトコルで、パケットロスに柔軟に対応
   - Ctrl+C が常に即座に機能（バッファの詰まりなし）

4. **セキュリティ**
   - root 権限不要でインストール・実行可能
   - SSH 経由で初期接続を確立（既存の認証方式をそのまま利用）
   - 接続後は UDP ポート 60000-61000 番台を使用

### tmux の強み

**ターミナルマルチプレクサ（セッション管理ツール）**

複数のターミナルセッションを効率的に管理するツールです。

**主な技術的特徴**:

1. **セッションの永続化**

   - ネットワーク切断後もプロセスが継続実行
   - 再接続時に作業を中断せず継続可能

2. **マルチデバイスアクセス**

   - 同一セッションに複数デバイスから同時接続
   - iPhone と Mac で同じ画面を共有して作業

3. **ウィンドウ・ペイン分割**

   - 1 つのターミナルで複数のプログラムを並行実行
   - 画面を分割して効率的に作業

4. **デタッチ/アタッチ**
   - セッションから一時的に離脱し、必要時に再接続
   - 長時間実行タスクをバックグラウンドで継続

---

## アーキテクチャ

### 接続フロー

```
iPhone (Termius アプリ)
    ↓
 Tailscale メッシュ VPN（ピアツーピア接続）
    ↓
macOS（開発マシン）
    ├─ Mosh サーバー（UDP 接続、ローミング対応）
    └─ tmux セッション（永続化、マルチデバイス共有）
```

### 各レイヤーの役割

| レイヤー         | 技術          | 役割                                                     |
| ---------------- | ------------- | -------------------------------------------------------- |
| **ネットワーク** | Tailscale VPN | デバイス間の安全な接続、NAT 越え、固定 IP 提供           |
| **接続**         | Mosh          | ネットワーク変動に強い接続、ローカルエコー、スリープ対応 |
| **セッション**   | tmux          | 接続切断後もプロセス継続、マルチデバイスアクセス         |

### なぜこの構成なのか

1. **Tailscale**: 外出先から自宅の Mac に安全にアクセス（ポート開放不要）
2. **Mosh**: 不安定なモバイル回線でも快適に操作（Wi-Fi ↔ LTE 切り替え時も接続維持）
3. **tmux**: 電車の中で作業を中断しても、自宅で続きから再開可能

---

## 必要なもの

### macOS 側

- macOS 12.0 (Monterey) 以降
- 管理者権限
- インターネット接続

### iPhone 側

- iOS デバイス
- App Store へのアクセス

---

## セットアップ手順

### 1. macOS 側の設定

#### 1.1 必要なパッケージのインストール

```bash
# このリポジトリのルートディレクトリで実行
sh apply.sh
```

プロンプトで以下を選択:

1. **brew** モジュールを選択

   - `tailscale` (cask)
   - `mosh` (brew)
   - `tmux` (brew)
     を選択してインストール

2. **dotfiles** モジュールを選択
   - tmux の設定ファイル (`.tmux.conf`) が自動的にコピーされます

#### 1.2 リモートログインの有効化

```bash
# システム設定 > 一般 > 共有 > リモートログイン をオンにする
# または GUI で設定:
```

1. システム設定を開く
2. **一般** > **共有** を選択
3. **リモートログイン** をオンにする
4. アクセスを許可するユーザーを選択（推奨: 管理者のみ）

#### 1.3 Tailscale のセットアップ

```bash
# Tailscale アプリを起動
open -a Tailscale
```

1. Tailscale アプリが起動したら、指示に従ってログイン
2. SSO プロバイダー（Google、GitHub など）で認証
3. 接続が完了したら、**macOS に割り当てられた Tailscale IP アドレス**を確認:

```bash
tailscale ip -4
```

**出力例**: `100.64.1.2`

**重要**: この IP アドレスは macOS（接続先サーバー）の Tailscale IP です。後の手順で使用するため、**必ずメモしておいてください**。

**補足**: Tailscale は各デバイスに `100.x.y.z` 形式の固定 IP を自動割り当てします。この IP は、デバイスが Tailscale ネットワークに参加している限り変わりません。

#### 1.4 Tailscale の 2FA 有効化（推奨）

1. [Tailscale 管理画面](https://login.tailscale.com/admin) にアクセス
2. **Settings** > **Users** から自分のアカウントを選択
3. **Two-factor authentication** を有効化

---

### 2. iPhone 側の設定

#### 2.1 必要なアプリのインストール

App Store から以下をインストール:

1. **Tailscale** - VPN 接続用
2. **Termius** - SSH/Mosh クライアント

#### 2.2 Tailscale のセットアップ

1. Tailscale アプリを起動
2. macOS と同じアカウントでログイン
3. 接続が完了すると、macOS と同じ VPN ネットワークに参加

#### 2.3 Termius のセットアップ

Termius を起動し、macOS への接続を設定:

1. Termius を起動
2. **Hosts** 画面で **+** をタップして新規ホストを追加
3. 以下を設定:
   - **Alias**: `mac`（任意の接続名）
   - **Hostname**: `<macOS の Tailscale IP>`
     - 例: `100.64.1.2`
     - **これは手順 1.3 でメモした macOS 側の IP アドレスです**
   - **Username**: `<macOS のユーザー名>`
     - macOS で `whoami` コマンドを実行すると確認できます
   - **Port**: `22`（SSH のデフォルトポート）
4. **Save** で保存

---

### 3. 接続テスト

#### 3.1 SSH 接続のテスト

Termius で:

```bash
ssh mac
```

初回接続時は、ホストキーの確認が表示されるので `yes` を入力。

#### 3.2 Mosh 接続のセットアップ

Mosh は SSH よりもモバイル環境に適した接続方式です。通常の SSH 接続でも問題ない場合はこのステップはスキップ可能です。

**Mosh の自動インストール（初回のみ）**

Termius で以下のコマンドを実行:

```bash
mosh <macOS のユーザー名>@<macOS の Tailscale IP>
```

**具体例**:

```bash
# macOS のユーザー名が masaki で、Tailscale IP が 100.64.1.2 の場合
mosh masaki@100.64.1.2
```

**入力する値の確認**:

- `<macOS のユーザー名>`: macOS で `whoami` を実行して確認（Termius 設定の Username と同じ）
- `<macOS の Tailscale IP>`: 手順 1.3 でメモした IP アドレス（Termius 設定の Hostname と同じ）

**初回実行時の動作**:

1. SSH 経由で macOS に接続
2. パスワードまたは SSH キーで認証
3. mosh-server が自動的にインストールされる（root 権限不要）
4. UDP 接続に切り替わる

**2 回目以降の接続**:

Termius の Hosts から `mac` を選択し、接続プロトコルで **Mosh** を選択するだけで接続できます。

または、Termius のターミナルで:

```bash
mosh mac
```

#### 3.3 tmux セッションの開始

macOS に接続できたら、tmux セッションを開始:

```bash
# 新しいセッションを作成
tmux new -s dev

# または既存のセッションに参加
tmux attach -t dev
```

---

## 基本的な使い方

### tmux の基本コマンド

#### セッション管理

```bash
# 新しいセッションを作成
tmux new -s <セッション名>

# 既存のセッションに参加
tmux attach -t <セッション名>

# セッション一覧を表示
tmux ls

# セッションから一時的に離脱（セッションは継続）
# Ctrl+B → d

# セッションを終了
exit
```

### 同一セッションを iPhone と Mac で共有

1. macOS または iPhone で tmux セッションを開始:

   ```bash
   tmux new -s dev
   ```

2. もう一方のデバイスから同じセッションに参加:

   ```bash
   mosh mac  # まず macOS に接続
   tmux attach -t dev  # 同じセッションに参加
   ```

3. どちらのデバイスで入力しても、両方の画面に反映されます

### 便利な設定（既に .tmux.conf に含まれています）

- **マウスサポート**: タッチ操作でペインを選択可能
- **vi キーバインド**: スクロールモードで vim のキーが使える
- **自動番号振り直し**: ウィンドウを閉じても番号が詰まる
- **ESC 遅延なし**: vim 使用時の遅延を解消

---

## トラブルシューティング

### Tailscale で macOS が見つからない

**原因**: 両デバイスで異なるアカウントを使用している、または接続が確立されていない

**解決方法**:

1. 両デバイスで同じ Tailscale アカウントにログインしているか確認
2. macOS で Tailscale の接続状態を確認:
   ```bash
   tailscale status
   ```
3. iPhone の Tailscale アプリで接続状態を確認

### Mosh で接続できない

**原因**: Mosh がインストールされていない、またはファイアウォールで UDP ポートがブロックされている

**解決方法**:

1. macOS 側で Mosh がインストールされているか確認:
   ```bash
   which mosh-server
   ```
2. Tailscale 経由の接続なので通常ファイアウォールは問題ないが、念のため確認:
   - システム設定 > ネットワーク > ファイアウォール
3. SSH で接続できるか確認（Mosh は SSH 経由で初期接続を行う）

### SSH で "Permission denied" エラー

**原因**: リモートログインが有効になっていない、またはユーザー権限の問題

**解決方法**:

1. macOS でリモートログインが有効か確認:
   - システム設定 > 一般 > 共有 > リモートログイン
2. 正しいユーザー名を使用しているか確認:
   ```bash
   # macOS で現在のユーザー名を確認
   whoami
   ```

### tmux セッションが見つからない

**原因**: セッションがまだ作成されていない、またはセッション名が間違っている

**解決方法**:

1. 既存のセッション一覧を確認:
   ```bash
   tmux ls
   ```
2. セッションが存在しない場合は新規作成:
   ```bash
   tmux new -s dev
   ```

### 接続が頻繁に切れる

**原因**: Mosh ではなく SSH を使用している、またはネットワークが不安定

**解決方法**:

1. Mosh で接続しているか確認（Mosh は接続が切れても自動的に再接続）
2. tmux セッションを使用すれば、接続が切れてもセッションは維持される
3. Tailscale の接続状態を確認

---

## セキュリティについて

### Tailscale のセキュリティ

- **ゼロトラスト VPN**: デバイス間の直接接続で、ポート開放不要
- **エンドツーエンド暗号化**: すべての通信が暗号化される
- **2FA 推奨**: Tailscale アカウントに 2 要素認証を設定することを強く推奨
- **デバイス認証**: 各デバイスは個別に認証される

### SSH のセキュリティ

- **公開鍵認証**: パスワード認証より安全（オプション）
- **Tailscale 経由**: インターネットから直接アクセスできない
- **ログ記録**: システムログで接続履歴を確認可能

### ベストプラクティス

1. **定期的なアップデート**: すべてのツールを最新版に保つ
2. **強力なパスワード**: macOS のユーザーアカウントに強力なパスワードを設定
3. **2FA 有効化**: Tailscale アカウントで必ず 2FA を有効化
4. **不要時は無効化**: 使用しない時はリモートログインを無効化（オプション）
5. **ログの監視**: 定期的に `/var/log/system.log` で不審なアクセスをチェック

---

## 追加オプション（将来的な拡張）

### code-server による GUI 編集

VS Code を iPhone の Safari で使用したい場合:

```bash
# macOS 側で code-server をインストール
brew install code-server

# code-server を起動
code-server

# iPhone の Safari で以下にアクセス
# http://<Tailscale IP>:8080
```

パスワードは `~/.config/code-server/config.yaml` に記載されています。

---

## まとめ

これで iPhone から macOS に安全にリモートアクセスし、開発作業ができる環境が整いました。

### この構成で実現できること

**モバイル環境での快適な開発**:

- 電車の中で iPhone からコーディング
- Wi-Fi ↔ LTE 切り替え時も接続継続
- カフェで Mac、帰宅後に iPhone で続きを作業

**ネットワークの制約からの解放**:

- ファイアウォールやルーターの設定変更不要
- 外出先から自宅の Mac に安全にアクセス
- NAT やポート開放の知識が不要

**作業の中断・再開が自由**:

- iPhone をスリープしても接続維持
- 長時間実行タスクをバックグラウンドで継続
- 複数デバイスで同じ画面を共有

### 技術スタックのまとめ

| 技術          | 解決する課題           | 主な利点                                         |
| ------------- | ---------------------- | ------------------------------------------------ |
| **Tailscale** | 複雑なネットワーク設定 | ゼロコンフィグ、ポート開放不要、P2P 接続         |
| **Mosh**      | モバイル回線の不安定性 | ローミング対応、ローカルエコー、パケットロス耐性 |
| **tmux**      | 接続切断による作業中断 | セッション永続化、マルチデバイスアクセス         |

### 推奨される使い方

1. **日常的なリモートアクセス**: Mosh + tmux で安定した接続
2. **長時間タスク**: tmux セッションでバックグラウンド実行
3. **ペアプログラミング**: 同一 tmux セッションを複数デバイスで共有
4. **外出先からの緊急対応**: iPhone から即座にサーバーにアクセス
