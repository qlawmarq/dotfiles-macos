# iPhone から macOS へのリモートアクセス設定ガイド

このドキュメントでは、iPhone から macOS に安全にリモートアクセスし、開発作業を可能にするための設定手順を説明します。

---

## 目次

- [概要](#概要)
- [アーキテクチャ](#アーキテクチャ)
- [必要なもの](#必要なもの)
- [セットアップ手順](#セットアップ手順)
  - [1. macOS 側の設定](#1-macos-側の設定)
  - [2. iPhone 側の設定](#2-iphone-側の設定)
  - [3. 接続テスト](#3-接続テスト)
- [基本的な使い方](#基本的な使い方)
- [トラブルシューティング](#トラブルシューティング)
- [セキュリティについて](#セキュリティについて)

---

## 概要

このセットアップでは、以下のツールを組み合わせて快適なリモート開発環境を構築します:

- **Tailscale**: ゼロトラスト VPN でポート開放不要の安全な接続
- **Mosh**: 不安定な回線でも切れにくいモバイルシェル
- **tmux**: iPhone と Mac で同一のターミナルセッションを共有

---

## アーキテクチャ

```
iPhone (Blink Shell)
    ↓
 Tailscale VPN
    ↓
macOS (開発マシン)
    ↓
tmux セッション
```

- **接続方法**: SSH + Mosh（Tailscale 経由）
- **セッション管理**: tmux で同一セッションを iPhone/Mac 両方で操作
- **セキュリティ**: Tailscale のゼロトラスト VPN で外部からの攻撃を防御

---

## 必要なもの

### macOS 側
- macOS 12.0 (Monterey) 以降
- 管理者権限
- インターネット接続

### iPhone 側
- iOS デバイス
- App Store へのアクセス

---

## セットアップ手順

### 1. macOS 側の設定

#### 1.1 必要なパッケージのインストール

```bash
# このリポジトリのルートディレクトリで実行
sh apply.sh
```

プロンプトで以下を選択:
1. **brew** モジュールを選択
   - `tailscale` (cask)
   - `mosh` (brew)
   - `tmux` (brew)
   を選択してインストール

2. **dotfiles** モジュールを選択
   - tmux の設定ファイル (`.tmux.conf`) が自動的にコピーされます

#### 1.2 リモートログインの有効化

```bash
# システム設定 > 一般 > 共有 > リモートログイン をオンにする
# または GUI で設定:
```

1. システム設定を開く
2. **一般** > **共有** を選択
3. **リモートログイン** をオンにする
4. アクセスを許可するユーザーを選択（推奨: 管理者のみ）

#### 1.3 Tailscale のセットアップ

```bash
# Tailscale アプリを起動
open -a Tailscale
```

1. Tailscale アプリが起動したら、指示に従ってログイン
2. SSO プロバイダー（Google、GitHub など）で認証
3. 接続が完了したら、macOS の Tailscale IP を確認:

```bash
tailscale ip -4
```

出力例: `100.64.1.2`（この IP をメモしておく）

#### 1.4 Tailscale の 2FA 有効化（推奨）

1. [Tailscale 管理画面](https://login.tailscale.com/admin) にアクセス
2. **Settings** > **Users** から自分のアカウントを選択
3. **Two-factor authentication** を有効化

---

### 2. iPhone 側の設定

#### 2.1 必要なアプリのインストール

App Store から以下をインストール:

1. **Tailscale** - VPN 接続用
2. **Blink Shell** - SSH/Mosh クライアント

#### 2.2 Tailscale のセットアップ

1. Tailscale アプリを起動
2. macOS と同じアカウントでログイン
3. 接続が完了すると、macOS と同じ VPN ネットワークに参加

#### 2.3 Blink Shell のセットアップ

Blink Shell を起動し、macOS への接続を設定:

1. Blink Shell を起動
2. `config` コマンドを実行
3. **Hosts** > **+** を選択
4. 以下を設定:
   - **Host**: `mac`（任意の名前）
   - **HostName**: `<macOS の Tailscale IP>`（例: `100.64.1.2`）
   - **User**: `<macOS のユーザー名>`
   - **Port**: `22`（デフォルト）

---

### 3. 接続テスト

#### 3.1 SSH 接続のテスト

Blink Shell で:

```bash
ssh mac
```

初回接続時は、ホストキーの確認が表示されるので `yes` を入力。

#### 3.2 Mosh の自動インストールと接続

```bash
# Mosh を自動インストール（初回のみ）
mosh --install-static <ユーザー名>@<Tailscale IP>

# 例:
mosh --install-static masaki@100.64.1.2
```

Blink Shell が自動的に mosh-server をインストールします（ホスト側に root 権限不要）。

インストール完了後、以降は以下で接続:

```bash
mosh mac
```

#### 3.3 tmux セッションの開始

macOS に接続できたら、tmux セッションを開始:

```bash
# 新しいセッションを作成
tmux new -s dev

# または既存のセッションに参加
tmux attach -t dev
```

---

## 基本的な使い方

### tmux の基本コマンド

#### セッション管理

```bash
# 新しいセッションを作成
tmux new -s <セッション名>

# 既存のセッションに参加
tmux attach -t <セッション名>

# セッション一覧を表示
tmux ls

# セッションから一時的に離脱（セッションは継続）
# Ctrl+B → d

# セッションを終了
exit
```

#### ウィンドウとペイン操作

すべてのコマンドは `Ctrl+B` の後にキーを押します:

| キー | 操作 |
|------|------|
| `c` | 新しいウィンドウを作成 |
| `n` | 次のウィンドウに移動 |
| `p` | 前のウィンドウに移動 |
| `0-9` | ウィンドウ番号で移動 |
| `\|` | 画面を左右に分割 |
| `-` | 画面を上下に分割 |
| `h/j/k/l` | ペイン間を移動（vim スタイル） |
| `x` | 現在のペインを閉じる |
| `[` | スクロールモード（`q` で終了） |
| `?` | すべてのキーバインドを表示 |

### 同一セッションを iPhone と Mac で共有

1. macOS または iPhone で tmux セッションを開始:
   ```bash
   tmux new -s dev
   ```

2. もう一方のデバイスから同じセッションに参加:
   ```bash
   mosh mac  # まず macOS に接続
   tmux attach -t dev  # 同じセッションに参加
   ```

3. どちらのデバイスで入力しても、両方の画面に反映されます

### 便利な設定（既に .tmux.conf に含まれています）

- **マウスサポート**: タッチ操作でペインを選択可能
- **vi キーバインド**: スクロールモードで vim のキーが使える
- **自動番号振り直し**: ウィンドウを閉じても番号が詰まる
- **ESC 遅延なし**: vim 使用時の遅延を解消

---

## トラブルシューティング

### Tailscale で macOS が見つからない

**原因**: 両デバイスで異なるアカウントを使用している、または接続が確立されていない

**解決方法**:
1. 両デバイスで同じ Tailscale アカウントにログインしているか確認
2. macOS で Tailscale の接続状態を確認:
   ```bash
   tailscale status
   ```
3. iPhone の Tailscale アプリで接続状態を確認

### Mosh で接続できない

**原因**: Mosh がインストールされていない、またはファイアウォールで UDP ポートがブロックされている

**解決方法**:
1. macOS 側で Mosh がインストールされているか確認:
   ```bash
   which mosh-server
   ```
2. Tailscale 経由の接続なので通常ファイアウォールは問題ないが、念のため確認:
   - システム設定 > ネットワーク > ファイアウォール
3. SSH で接続できるか確認（Mosh は SSH 経由で初期接続を行う）

### SSH で "Permission denied" エラー

**原因**: リモートログインが有効になっていない、またはユーザー権限の問題

**解決方法**:
1. macOS でリモートログインが有効か確認:
   - システム設定 > 一般 > 共有 > リモートログイン
2. 正しいユーザー名を使用しているか確認:
   ```bash
   # macOS で現在のユーザー名を確認
   whoami
   ```

### tmux セッションが見つからない

**原因**: セッションがまだ作成されていない、またはセッション名が間違っている

**解決方法**:
1. 既存のセッション一覧を確認:
   ```bash
   tmux ls
   ```
2. セッションが存在しない場合は新規作成:
   ```bash
   tmux new -s dev
   ```

### 接続が頻繁に切れる

**原因**: Mosh ではなく SSH を使用している、またはネットワークが不安定

**解決方法**:
1. Mosh で接続しているか確認（Mosh は接続が切れても自動的に再接続）
2. tmux セッションを使用すれば、接続が切れてもセッションは維持される
3. Tailscale の接続状態を確認

---

## セキュリティについて

### Tailscale のセキュリティ

- **ゼロトラスト VPN**: デバイス間の直接接続で、ポート開放不要
- **エンドツーエンド暗号化**: すべての通信が暗号化される
- **2FA 推奨**: Tailscale アカウントに 2 要素認証を設定することを強く推奨
- **デバイス認証**: 各デバイスは個別に認証される

### SSH のセキュリティ

- **公開鍵認証**: パスワード認証より安全（オプション）
- **Tailscale 経由**: インターネットから直接アクセスできない
- **ログ記録**: システムログで接続履歴を確認可能

### ベストプラクティス

1. **定期的なアップデート**: すべてのツールを最新版に保つ
2. **強力なパスワード**: macOS のユーザーアカウントに強力なパスワードを設定
3. **2FA 有効化**: Tailscale アカウントで必ず 2FA を有効化
4. **不要時は無効化**: 使用しない時はリモートログインを無効化（オプション）
5. **ログの監視**: 定期的に `/var/log/system.log` で不審なアクセスをチェック

---

## 追加オプション（将来的な拡張）

### code-server による GUI 編集

VS Code を iPhone の Safari で使用したい場合:

```bash
# macOS 側で code-server をインストール
brew install code-server

# code-server を起動
code-server

# iPhone の Safari で以下にアクセス
# http://<Tailscale IP>:8080
```

パスワードは `~/.config/code-server/config.yaml` に記載されています。

### tmux プラグインマネージャー

セッションの自動保存・復元機能を追加:

```bash
# tmux plugin manager をインストール
git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm

# .tmux.conf のプラグインセクションのコメントを外す
# （ファイル末尾の Plugin Support セクション）

# tmux 内で Ctrl+B → Shift+I でプラグインをインストール
```

---

## まとめ

これで iPhone から macOS に安全にリモートアクセスし、開発作業ができる環境が整いました。

主な利点:
- ✅ 不安定な回線でも安定した接続（Mosh）
- ✅ セッションの永続化（tmux）
- ✅ セキュアな通信（Tailscale VPN）
- ✅ ポート開放不要
- ✅ iPhone と Mac で同一セッションを共有

問題が発生した場合は、[トラブルシューティング](#トラブルシューティング) セクションを参照してください。
