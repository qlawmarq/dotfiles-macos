# ====================================================================================
# tmux Configuration - Optimized for Claude Code & Mobile Development
# ====================================================================================
#
# Last Updated: 2025 (tmux 3.5+ compatible)
# Optimized for: Claude Code, iOS/Mobile Access, CJK Characters
#
# Design Philosophy:
# - Claude Code: Large scrollback buffer, true color, verbose output support
# - Local: Match zsh/VSCode keybindings for seamless experience
# - Remote (iPhone): Optimize for small screens and touch input (Shellfish/Blink Shell)
# - CJK Characters: Modern terminal type for better Unicode handling
# - Clipboard: Smooth integration across all platforms
#
# Key Features:
# - Terminal type: tmux-256color (modern, supports italics and better CJK)
# - Scrollback: 500000 lines (optimized for Claude Code's verbose output)
# - True color: Full 24-bit RGB support for modern themes
# - Mouse support: Touch-friendly for iOS devices
# - Copy/Paste: Auto-copy on selection, right-click paste
#
# ====================================================================================

# ====================================================================================
# BASIC SETTINGS
# ====================================================================================

# Terminal Type Configuration (Updated 2025)
# ---------------------------------------------
# Modern recommendation: tmux-256color (tmux 2.6+, supports italics and better colors)
# Benefits over screen-256color:
# - Italics support (screen doesn't support italics)
# - More accurate color rendering
# - Better CJK character handling with modern ncurses
#
# Note: If you experience issues on older systems, fallback to "screen-256color"
set -g default-terminal "tmux-256color"

# True Color (24-bit RGB) Support
# --------------------------------
# Modern tmux (3.2+) uses terminal-features for RGB support
set -as terminal-features ",*:RGB"

# Legacy terminal-overrides for compatibility with older applications
# This ensures true color works with apps that check TERM directly
set-option -sa terminal-overrides ",tmux*:Tc"

# Enable mouse support for easier navigation (especially on iPhone)
set -g mouse on

# Start window and pane numbering from 1 (more ergonomic)
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed (no gaps)
set -g renumber-windows on

# Scrollback Buffer Size - Optimized for Claude Code
# ---------------------------------------------------
# Claude Code generates verbose output (explanations, code suggestions, diffs)
# Recommendation from community: 50000-500000 lines
# 500000 lines ≈ 250 MB RAM (adjust based on your device's memory)
#
# For reference:
# - Default tmux: 2000 lines
# - Standard usage: 50000 lines
# - Claude Code usage: 500000 lines (recommended by Brian P. Hogan & community)
set -g history-limit 500000

# ESC Key Response Time
# ----------------------
# Reduces delay when pressing ESC in vim/neovim
# tmux 3.5 default: 10ms (improved from previous 500ms)
# Setting to 0 for instant response (safe with modern terminals)
set -sg escape-time 0

# Aggressive resize (only resize when smaller client is viewing)
setw -g aggressive-resize on

# Don't rename windows automatically (preserve custom names)
set -g allow-rename off

# ====================================================================================
# CLAUDE CODE OPTIMIZATIONS
# ====================================================================================

# Enable focus events for better vim/neovim integration
# Allows editors to detect when tmux pane gains/loses focus
set -g focus-events on

# Display messages for longer (Claude Code outputs can be verbose)
# Default: 750ms → Increased to 3000ms (3 seconds)
set -g display-time 3000

# Display pane numbers for longer (easier to see on small screens)
# Default: 1000ms → Increased to 4000ms (4 seconds)
set -g display-panes-time 4000

# ====================================================================================
# KEY BINDINGS - ZSH/VSCODE COMPATIBLE
# ====================================================================================

# Use Emacs-style key bindings for command prompt (matches zsh default)
# Ctrl+A: beginning of line, Ctrl+E: end of line, Ctrl+K: kill to end, etc.
set -g status-keys emacs

# Use vi-style key bindings for copy mode (vim-like navigation)
setw -g mode-keys vi

# Reload config file easily
bind r source-file ~/.tmux.conf \; display "tmux.conf reloaded!"

# Intuitive pane splitting (| for vertical, - for horizontal)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# New window in current path
bind c new-window -c "#{pane_current_path}"

# Pane navigation with vim-like keys (no prefix needed for Alt+arrows)
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# Also keep hjkl navigation (with prefix)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Pane resizing with vim-like keys
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Window navigation (Ctrl+Left/Right without prefix)
bind -n C-Left previous-window
bind -n C-Right next-window

# ====================================================================================
# CLIPBOARD INTEGRATION - MACOS (Cmd+V & Right-click paste)
# ====================================================================================

# Enable system clipboard integration (tmux 2.6+)
set -s set-clipboard on

# Copy mode bindings (vi-style with clipboard integration)
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode-vi Enter send -X copy-pipe-and-cancel "pbcopy"

# Mouse drag to copy (auto-copy on mouse release)
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "pbcopy"

# Right-click to paste (works on iPhone and desktop)
bind -n MouseDown3Pane select-pane -t= \; paste-buffer

# Quick paste with prefix + p (alternative method)
bind p paste-buffer

# Quick copy mode with prefix + [
bind [ copy-mode

# ====================================================================================
# DISPLAY SETTINGS - MOBILE & CLAUDE CODE OPTIMIZED
# ====================================================================================

# Status bar position: top (iOS keyboard doesn't cover it when typing)
# Also keeps important session info visible while Claude Code generates output
set -g status-position top

# Update status bar frequently (real-time feedback)
set -g status-interval 5

# ====================================================================================
# COLOR SCHEME - HIGH CONTRAST FOR MOBILE
# ====================================================================================

# Status bar colors (simple and readable)
set -g status-style bg=black,fg=white

# Current window highlight (bright and obvious)
setw -g window-status-current-style bg=blue,fg=white,bold
setw -g window-status-style bg=black,fg=white

# Pane border (clear distinction between panes)
set -g pane-border-style fg=colour240
set -g pane-active-border-style fg=colour33,bold

# Message style
set -g message-style bg=yellow,fg=black,bold

# ====================================================================================
# STATUS BAR - MINIMAL & MOBILE-FRIENDLY
# ====================================================================================

# Left side: session name only (short and clear)
set -g status-left '[#S] '
set -g status-left-length 20

# Right side: minimal info (just time, no date/seconds for space saving)
set -g status-right '%H:%M'
set -g status-right-length 10

# Window list format (compact)
setw -g window-status-format ' #I:#W '
setw -g window-status-current-format ' #I:#W '

# ====================================================================================
# MOUSE BEHAVIOR - ENHANCED FOR MOBILE
# ====================================================================================

# Enhanced mouse wheel behavior in copy mode
bind -n WheelUpPane if -Ft= "#{||:#{pane_in_mode},#{mouse_any_flag}}" \
    "send -M" \
    "if -F '#{alternate_on}' 'send-keys -N 3 Up' 'copy-mode -e'"

bind -n WheelDownPane if -Ft= "#{||:#{pane_in_mode},#{mouse_any_flag}}" \
    "send -M" \
    "if -F '#{alternate_on}' 'send-keys -N 3 Down'"

# ====================================================================================
# COPY MODE - VIM-STYLE ENHANCEMENTS
# ====================================================================================

# Additional copy mode bindings for easier text selection
bind -T copy-mode-vi C-v send -X rectangle-toggle
bind -T copy-mode-vi Escape send -X cancel

# Monitor activity in other windows (useful for long-running Claude Code tasks)
setw -g monitor-activity on
set -g visual-activity off

# ====================================================================================
# QUICK REFERENCE
# ====================================================================================
#
# === Session Management (Essential for Claude Code) ===
# - tmux new -s <name>: Create new named session
# - tmux attach -t <name>: Attach to existing session
# - tmux ls: List all sessions
# - Prefix + d: Detach from session (Claude Code keeps running!)
# - Prefix + s: Select session from list
#
# === Copy & Paste ===
# - Mouse drag: Select and auto-copy to clipboard
# - Cmd+V: Paste from clipboard (macOS standard)
# - Right-click: Paste from clipboard (works on iPhone)
# - Prefix + p: Paste (alternative)
#
# === Copy Mode (Prefix + [) - Useful for scrolling Claude Code output ===
# - h/j/k/l: Navigate
# - Ctrl+u / Ctrl+d: Page up/down
# - g / G: Go to top/bottom
# - /: Search forward
# - ?: Search backward
# - v: Start selection
# - y: Copy to clipboard
# - Escape: Exit copy mode
#
# === Pane Management ===
# - Prefix + |: Split vertically
# - Prefix + -: Split horizontally
# - Alt + Arrow: Navigate panes (no prefix)
# - Prefix + h/j/k/l: Navigate panes (vim-style)
# - Prefix + H/J/K/L: Resize pane
#
# === Window Management ===
# - Prefix + c: New window
# - Ctrl + Left/Right: Navigate windows (no prefix)
#
# === Other ===
# - Prefix + r: Reload config
# - Mouse: Click to select pane, drag to resize
#
# ====================================================================================
# CLAUDE CODE WORKFLOW TIPS
# ====================================================================================
#
# Recommended setup for Claude Code:
#
# Layout 1: Side-by-side (Recommended by Brian P. Hogan)
# ┌─────────────────┬─────────────────┐
# │                 │                 │
# │  Claude Code    │  Shell/Git      │
# │  (Pane 1)       │  (Pane 2)       │
# │                 │                 │
# └─────────────────┴─────────────────┘
# - Pane 1: Run Claude Code with verbose output
# - Pane 2: Execute git commands, tests, builds
#
# Layout 2: Stacked (For smaller screens)
# ┌─────────────────────────────────┐
# │     Claude Code (Pane 1)        │
# │                                 │
# ├─────────────────────────────────┤
# │     Shell/Git (Pane 2)          │
# └─────────────────────────────────┘
#
# Best Practices:
# - Use named sessions: tmux new -s project-name
# - Detach instead of killing: Prefix + d (preserves Claude Code state)
# - Use scrollback extensively: Prefix + [ to review Claude's explanations
# - Split panes for parallel work: Claude in one, manual tasks in another
# - Monitor long tasks: setw -g monitor-activity on (already enabled)
#
# Troubleshooting:
# - If colors look wrong: Check TERM is "tmux-256color" (echo $TERM)
# - If scrollback is slow: Reduce history-limit (currently 500000)
# - If Japanese text looks broken: Try "screen-256color" instead
# - If stuck in copy mode: Press Escape or q
#
# ====================================================================================
